<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script type="text/javascript">
        $(function () {
            $(document).ready(function () {
                var campID = JSON.parse(sessionStorage.getItem("campID"));
                $.getJSON('/morari/admin/camp/sitesOfCamp.controller/' + campID, function (data) {
                    var div = $('#div');
                    var tmp = '';
                    div.append('<div><span>營位區編號</span><span>營位區名</span><span>營區位圖片</span><span>總營位</span><span>營位金額</span></div>');
                    $.each(data, function (i, n) {
                        tmp = '<div id="order' + n.siteID + '">'
                            + '<span name="siteID">' + n.siteID + '<span id="errorsiteID" style="color: red;"></span></span>'
                            + '<span>' + n.siteName + '</span>'
                            + '<span>' + '<img width="80" height="100" src="/morari/images/' + n.sitePicturesPath + '">' + '</span>'
                            + '<span>' + n.totalSites + '</span>'
                            + '<span name="unitPrice">' + n.siteMoney + '</span>'
                            + '<span name="numbers">預約數量</span><input name="num" type="number" min="0" step="1" value="0"><span><span id="errornumbers" style="color: red;"></span>'
                            + '</div>'
                        div.append(tmp);
                    });
                    div.append('<span>入營時間:<input type="date" name="goingdate"></span>');
                    div.append('<span>離營時間:<input type="date" name="leavingdate"><br>');
                    div.append('<button id="addOrder">結帳</button><span id="errornone" style="color: red;"></span><span id="errordate" style="color: red;"></span></span>');
                })


                $('body').on('click', '#addOrder', function () {
                    let siteIds = [];
                    let nums = [];
                    let orderItems = $('div[id^="order"]');
                    $.each(orderItems, function (index, orderItem) {
                        let siteId = $($(orderItem).find('span[name="siteID"]').get(0)).text();
                        let num = $($(orderItem).find('input[name="num"]').get(0)).val();
                        siteIds.push(siteId);
                        nums.push(num);
                    });
                    let goingdate = $($('#div').find('input[name="goingdate"]').get(0)).val();
                    let leavingdate = $($('#div').find('input[name="leavingdate"]').get(0)).val();

                    var formData = new FormData();
                    formData.append('siteIds', siteIds);
                    formData.append('nums', nums);
                    formData.append('goingdate', goingdate);
                    formData.append('leavingdate', leavingdate);
                    formData.append('campID', campID);

                    $.ajax({
                        url: '/morari/admin/camp/insertOrder.controller',
                        type: 'post',
                        data: formData,
                        contentType: false,
                        cache: false,
                        processData: false,
                        success: function (after) {
                            if (after.error == 'true') {
                                $("#errorsiteID").append(after.siteIds);
                                $("#errornumbers").append(after.nums);
                                $("#errordate").append(after.timeString);
                                return;
                            }
                            else if (after.error == 'none') {
                                $("#errornone").append(after.noData);
                                return;
                            }
                        }
                    });
                });
            });
        });


    </script>
</head>

<body>
    <div id="div"></div>
</body>

</html>